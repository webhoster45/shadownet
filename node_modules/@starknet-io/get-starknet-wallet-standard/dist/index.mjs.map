{"version":3,"file":"index.mjs","sources":["../src/injected-wallet.ts"],"sourcesContent":["import type { RequestFn, StarknetWindowObject } from \"@starknet-io/types-js\";\nimport type { Wallet } from \"@wallet-standard/base\";\nimport {\n  StandardConnect,\n  type StandardConnectMethod,\n  StandardDisconnect,\n  type StandardDisconnectMethod,\n  StandardEvents,\n  type StandardEventsListeners,\n  type StandardEventsNames,\n  type StandardEventsOnMethod,\n} from \"@wallet-standard/features\";\n\nimport {\n  formatStarknetChainId,\n  isStarknetChain,\n  type StarknetChain,\n  WELL_KNOWN_STARKNET_CHAINS,\n} from \"./chains\";\nimport {\n  type StarknetFeatures,\n  StarknetWalletApi,\n  type WalletWithStarknetFeatures,\n} from \"./features\";\nimport type { StarknetWalletAccount } from \"./wallet\";\n\nexport class StarknetInjectedWallet implements WalletWithStarknetFeatures {\n  #listeners: { [E in StandardEventsNames]?: StandardEventsListeners[E][] } =\n    {};\n  #account: { address: string; chain: StarknetChain } | null = null;\n\n  constructor(private readonly injected: StarknetWindowObject) {\n    this.injected.on(\"accountsChanged\", this.#onAccountsChanged.bind(this));\n    this.injected.on(\"networkChanged\", this.#onNetworkChanged.bind(this));\n  }\n\n  get version() {\n    return \"1.0.0\" as const;\n  }\n\n  get name() {\n    return this.injected.name;\n  }\n\n  get icon() {\n    if (typeof this.injected.icon === \"string\") {\n      return this.injected.icon as Wallet[\"icon\"];\n    }\n\n    return this.injected.icon.light as Wallet[\"icon\"];\n  }\n\n  get features(): StarknetFeatures {\n    return {\n      [StandardConnect]: {\n        version: \"1.0.0\" as const,\n        connect: this.#connect.bind(this),\n      },\n      [StandardDisconnect]: {\n        version: \"1.0.0\" as const,\n        disconnect: this.#disconnect.bind(this),\n      },\n      [StandardEvents]: {\n        version: \"1.0.0\" as const,\n        on: this.#on.bind(this),\n      },\n      [StarknetWalletApi]: {\n        id: this.injected.id,\n        version: \"1.0.0\" as const,\n        request: this.#request.bind(this),\n        walletVersion: this.injected.version,\n      },\n    };\n  }\n\n  get chains() {\n    return WELL_KNOWN_STARKNET_CHAINS.slice();\n  }\n\n  get accounts(): StarknetWalletAccount[] {\n    if (this.#account) {\n      return [\n        {\n          address: this.#account.address,\n          publicKey: new Uint8Array(),\n          chains: [this.#account.chain],\n          features: [],\n        },\n      ];\n    }\n\n    return [];\n  }\n\n  #connect: StandardConnectMethod = async ({ silent }) => {\n    if (!this.#account) {\n      const accounts = await this.injected.request({\n        type: \"wallet_requestAccounts\",\n        params: {\n          silent_mode: silent,\n        },\n      });\n\n      // TODO(fra): maybe we should throw an error here?\n      // User rejected the request.\n      if (accounts.length === 0) {\n        return { accounts: [] };\n      }\n\n      await this.#updateAccount(accounts);\n    }\n\n    return { accounts: this.accounts };\n  };\n\n  #disconnect: StandardDisconnectMethod = async () => {\n    this.#disconnected();\n  };\n\n  #on: StandardEventsOnMethod = (event, listener) => {\n    if (!this.#listeners[event]) {\n      this.#listeners[event] = [];\n    }\n\n    this.#listeners[event].push(listener);\n\n    return (): void => this.#off(event, listener);\n  };\n\n  #emit<E extends StandardEventsNames>(\n    event: E,\n    ...args: Parameters<StandardEventsListeners[E]>\n  ): void {\n    if (!this.#listeners[event]) return;\n\n    for (const listener of this.#listeners[event]) {\n      listener.apply(null, args);\n    }\n  }\n\n  #off<E extends StandardEventsNames>(\n    event: E,\n    listener: StandardEventsListeners[E],\n  ): void {\n    this.#listeners[event] = this.#listeners[event]?.filter(\n      (existingListener) => listener !== existingListener,\n    );\n  }\n\n  #disconnected() {\n    if (this.#account) {\n      this.#account = null;\n      this.#emit(\"change\", { accounts: this.accounts });\n    }\n  }\n\n  async #onAccountsChanged(accounts: string[]) {\n    if (!accounts || accounts.length === 0) {\n      this.#disconnected();\n      return;\n    }\n\n    if (!this.#account) {\n      return;\n    }\n\n    await this.#updateAccount(accounts);\n  }\n\n  #onNetworkChanged(chainId?: string, accounts?: string[]) {\n    if (!chainId) {\n      this.#disconnected();\n      return;\n    }\n\n    if (!this.#account) {\n      return;\n    }\n\n    const chain = formatStarknetChainId(chainId);\n\n    if (!isStarknetChain(chain)) {\n      throw new Error(`Invalid Starknet chain: ${chain}`);\n    }\n\n    // Some wallets (like Keplr) don't provide accounts on network change.\n    if (accounts?.length > 0) {\n      const [account] = accounts;\n\n      this.#account = { address: account, chain };\n      this.#emit(\"change\", { accounts: this.accounts });\n    } else {\n      this.#account = { address: this.#account?.address, chain };\n      this.#emit(\"change\", { accounts: this.accounts });\n    }\n  }\n\n  async #updateAccount(accounts: string[]) {\n    if (accounts.length === 0) {\n      return;\n    }\n\n    const [account] = accounts;\n\n    if (this.#account?.chain) {\n      // Only account changed. No need to make a request for the chain id.\n      this.#account.address = account;\n      this.#emit(\"change\", { accounts: this.accounts });\n    } else {\n      const chain = await this.#getStarknetChain();\n      this.#account = { address: account, chain };\n      this.#emit(\"change\", { accounts: this.accounts });\n    }\n  }\n\n  #request(...args: Parameters<RequestFn>): ReturnType<RequestFn> {\n    return this.injected.request(...args);\n  }\n\n  async #getStarknetChain(): Promise<StarknetChain> {\n    const chainId = await this.injected.request({\n      type: \"wallet_requestChainId\",\n    });\n    const chain = formatStarknetChainId(chainId);\n\n    if (!isStarknetChain(chain)) {\n      throw new Error(`Invalid Starknet chain: ${chain}`);\n    }\n\n    return chain;\n  }\n}\n"],"names":[],"mappings":"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"}